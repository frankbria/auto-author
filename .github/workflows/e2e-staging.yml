name: E2E Tests on Staging

# IMPORTANT: This workflow runs POST-DEPLOYMENT and is INFORMATIONAL ONLY
# E2E test failures DO NOT block staging deployment or rollback the release
# The 3-tier CI/CD strategy:
#   Tier 1 (BLOCKS): Fast tests (lint, typecheck, unit, build) - 3-5 min
#   Tier 2 (AUTO): Deploy to staging - 1-2 min
#   Tier 3 (INFORMATIONAL): E2E tests - 10-15 min
#
# This workflow is Tier 3 - it validates the deployed environment but does not
# prevent the deployment from completing. If E2E tests fail, the team is notified
# and can decide whether to fix forward or rollback using scripts/rollback.sh

on:
  workflow_run:
    workflows: ["Deploy to Staging"]
    types: [completed]
    branches: [develop]
  workflow_dispatch:
    inputs:
      staging_url:
        description: 'Staging URL to test'
        required: false
        default: 'https://dev.autoauthor.app'

env:
  STAGING_URL: https://dev.autoauthor.app
  STAGING_API_URL: https://api.dev.autoauthor.app

jobs:
  e2e-tests:
    name: Run E2E Tests Against Staging
    runs-on: ubuntu-latest
    # Run if deployment succeeded OR if manually triggered
    # NOTE: This job runs AFTER deployment is complete and does NOT block staging
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    # Access staging environment secrets (CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY, etc.)
    environment:
      name: staging
      url: https://dev.autoauthor.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Wait for staging to be ready
        run: |
          echo "Waiting for staging server to be ready..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s ${{ env.STAGING_API_URL }}/api/v1/health > /dev/null; then
              echo "✅ Staging server is ready!"
              break
            fi

            echo "⏳ Attempt $((attempt + 1))/$max_attempts - waiting for staging..."
            sleep 10
            attempt=$((attempt + 1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Staging server did not become ready in time"
            exit 1
          fi

      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npx playwright test tests/e2e/deployment --config=tests/e2e/deployment/playwright.config.ts
        env:
          DEPLOYMENT_URL: ${{ env.STAGING_URL }}
          BASE_URL: ${{ env.STAGING_URL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          NEXT_PUBLIC_API_URL: ${{ env.STAGING_API_URL }}/api/v1
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv venv
          source .venv/bin/activate
          uv pip install -r requirements.txt
          uv pip install pytest pytest-asyncio

      - name: Run backend E2E tests with real APIs
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          pytest tests/test_e2e_no_mocks.py \
            tests/test_debug_chapter_questions.py \
            tests/test_debug_questions.py \
            tests/test_api/test_routes/test_toc_generation.py::test_generate_toc_endpoint \
            tests/test_api/test_routes/test_toc_generation.py::test_toc_generation_workflow_e2e \
            -v --tb=short
        env:
          # Use staging environment
          DATABASE_URI: mongodb://localhost:27017
          DATABASE_NAME: autoauthor_e2e_test

          # Real API keys from secrets
          OPENAI_AUTOAUTHOR_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLERK_API_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_JWT_PUBLIC_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_FRONTEND_API: https://delicate-ladybird-47.clerk.accounts.dev
          CLERK_BACKEND_API: https://api.clerk.dev

          # Test against staging server
          BASE_URL: ${{ env.STAGING_API_URL }}
          ENVIRONMENT: staging

      - name: Upload Playwright test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-e2e-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload backend test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-e2e-logs
          path: backend/test-logs/
          retention-days: 7

      # Notify on E2E test failures (informational - does NOT block deployment)
      - name: Notify E2E Failure
        if: failure()
        run: |
          echo "## 🚨 E2E Test Failure (Non-Blocking)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "E2E tests failed but **staging deployment is already live**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging URL**: https://dev.autoauthor.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Playwright Report**: Check artifacts for detailed test results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review test failure artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify staging environment manually" >> $GITHUB_STEP_SUMMARY
          echo "3. Decide: Fix forward or rollback?" >> $GITHUB_STEP_SUMMARY
          echo "4. To rollback: \`ssh user@dev.autoauthor.app 'bash /opt/auto-author/current/scripts/rollback.sh'\`" >> $GITHUB_STEP_SUMMARY

      # TODO: Add Slack/Discord webhook notification
      # - name: Send Slack Notification
      #   if: failure()
      #   run: |
      #     curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "channel": "#dev-alerts",
      #         "text": "🚨 E2E tests failed on staging (non-blocking)",
      #         "attachments": [{
      #           "color": "warning",
      #           "fields": [
      #             {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
      #             {"title": "Commit", "value": "${{ github.sha }}", "short": true},
      #             {"title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
      #           ]
      #         }]
      #       }'
