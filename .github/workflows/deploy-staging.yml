name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["Test Suite"]
    types: [completed]
    branches: [main]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

# Required GitHub Secrets:
# SSH & Server:
#   - SSH_KEY: Private SSH key for server access
#   - HOST: Server hostname/IP
#   - USER: SSH username
#
# URLs:
#   - API_URL: Backend API URL (e.g., https://api.dev.autoauthor.app)
#   - FRONTEND_URL: Frontend URL (e.g., https://dev.autoauthor.app)
#
# Database:
#   - MONGODB_URI: MongoDB connection string
#   - DATABASE_NAME: Database name (e.g., auto_author_staging)
#
# OpenAI:
#   - OPENAI_API_KEY: OpenAI API key
#
# Clerk Authentication:
#   - CLERK_PUBLISHABLE_KEY: Clerk publishable key (pk_*)
#   - CLERK_SECRET_KEY: Clerk secret key (sk_*)
#   - CLERK_API_KEY: Clerk API key
#   - CLERK_FRONTEND_API: Clerk frontend API (e.g., your-app.clerk.accounts.dev)
#   - CLERK_BACKEND_API: Clerk backend API (api.clerk.com)
#   - CLERK_WEBHOOK_SECRET: Clerk webhook secret
#
# Optional (AWS):
#   - AWS_ACCESS_KEY_ID
#   - AWS_SECRET_ACCESS_KEY
#   - AWS_REGION
#   - AWS_S3_BUCKET
#
# Optional (Cloudinary):
#   - CLOUDINARY_CLOUD_NAME
#   - CLOUDINARY_API_KEY
#   - CLOUDINARY_API_SECRET

jobs:
  build-and-deploy:
    name: Build and Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}

    environment:
      name: staging
      url: https://dev.autoauthor.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_ENVIRONMENT: staging
        run: |
          npm ci
          npm run build

      - name: Create deployment package
        run: |
          # Create temporary directory
          mkdir -p /tmp/deploy

          # Copy necessary files (exclude development artifacts)
          rsync -av --progress \
            --exclude='node_modules' \
            --exclude='.venv' \
            --exclude='.next' \
            --exclude='coverage' \
            --exclude='*.log' \
            --exclude='.env.local' \
            --exclude='.env' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='test-results' \
            --exclude='playwright-report' \
            --exclude='.git' \
            . /tmp/deploy/

          # Create tar archive
          cd /tmp/deploy
          tar -czf /tmp/deploy-package.tar.gz .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Upload package to server
        run: |
          scp -i ~/.ssh/staging_key /tmp/deploy-package.tar.gz \
            ${{ secrets.USER }}@${{ secrets.HOST }}:/tmp/

      - name: Deploy to staging
        run: |
          ssh -i ~/.ssh/staging_key \
            ${{ secrets.USER }}@${{ secrets.HOST }} \
            'bash -s' << 'ENDSSH'
          set -euo pipefail

          ENVIRONMENT="staging"
          RELEASE_ID="$(date +%Y%m%d-%H%M%S)"
          API_URL="${{ secrets.API_URL }}"
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          CLERK_PUBLISHABLE_KEY="${{ secrets.CLERK_PUBLISHABLE_KEY }}"
          CLERK_SECRET_KEY="${{ secrets.CLERK_SECRET_KEY }}"

          DEPLOY_BASE="/opt/auto-author"
          RELEASE_DIR="$DEPLOY_BASE/releases/$RELEASE_ID"
          CURRENT_DIR="$DEPLOY_BASE/current"

          echo "==> Deploying $ENVIRONMENT environment (Release: $RELEASE_ID)"

          # Create release directory
          mkdir -p "$RELEASE_DIR"

          # Extract uploaded package
          echo "==> Extracting deployment package..."
          tar -xzf /tmp/deploy-package.tar.gz -C "$RELEASE_DIR"

          # Setup backend environment
          echo "==> Setting up backend..."
          cd "$RELEASE_DIR/backend"

          # Install Python dependencies using uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          uv venv
          source .venv/bin/activate
          uv sync

          # Create backend .env file with all required variables
          echo "==> Creating backend .env file..."
          {
            echo "# Database"
            echo "DATABASE_URI=${{ secrets.MONGODB_URI }}"
            echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}"
            echo ""
            echo "# CORS Settings"
            echo "BACKEND_CORS_ORIGINS=[\"$FRONTEND_URL\",\"$API_URL\"]"
            echo ""
            echo "# OpenAI"
            echo "OPENAI_AUTOAUTHOR_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            echo ""
            echo "# Clerk Authentication"
            echo "CLERK_API_KEY=${{ secrets.CLERK_API_KEY }}"
            echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY"
            echo "CLERK_FRONTEND_API=${{ secrets.CLERK_FRONTEND_API }}"
            echo "CLERK_BACKEND_API=${{ secrets.CLERK_BACKEND_API }}"
            echo "CLERK_WEBHOOK_SECRET=${{ secrets.CLERK_WEBHOOK_SECRET }}"
            echo "CLERK_JWT_ALGORITHM=RS256"
            echo ""
            echo "# API Settings"
            echo "API_V1_PREFIX=/api/v1"
            echo ""
            echo "# AWS Settings (Optional)"
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}"
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            echo "AWS_REGION=${{ secrets.AWS_REGION }}"
            echo "AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}"
            echo ""
            echo "# Cloudinary Settings (Optional)"
            echo "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}"
            echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}"
            echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}"
          } > .env

          # Verify .env file was created
          if [ ! -f .env ]; then
            echo "ERROR: Failed to create backend .env file"
            exit 1
          fi
          echo "✓ Backend .env file created"

          # Setup frontend environment
          echo "==> Setting up frontend..."
          cd "$RELEASE_DIR/frontend"

          # Create/update .env.production with all required variables
          {
            echo "NEXT_PUBLIC_API_URL=$API_URL"
            echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$CLERK_PUBLISHABLE_KEY"
            echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY"
            echo "NEXT_PUBLIC_ENVIRONMENT=$ENVIRONMENT"
            echo "PORT=3002"
          } > .env.production

          # Export environment variables for build process
          export NEXT_PUBLIC_API_URL=$API_URL
          export NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$CLERK_PUBLISHABLE_KEY
          export CLERK_SECRET_KEY=$CLERK_SECRET_KEY
          export NEXT_PUBLIC_ENVIRONMENT=$ENVIRONMENT

          # Install dependencies and build
          # Remove old .next cache to prevent stale builds
          echo "==> Cleaning old build cache..."
          rm -rf .next

          echo "==> Installing frontend dependencies..."
          npm ci

          echo "==> Building frontend..."
          npm run build

          # Update symlink atomically
          echo "==> Switching to new release..."
          ln -snf "$RELEASE_DIR" "$CURRENT_DIR.tmp"
          mv -Tf "$CURRENT_DIR.tmp" "$CURRENT_DIR"

          # Restart backend service with environment loaded
          echo "==> Restarting backend service..."
          cd "$CURRENT_DIR/backend"
          source .venv/bin/activate
          pm2 restart auto-author-backend || pm2 start "$(which uvicorn)" --name auto-author-backend --interpreter "$(which python)" -- app.main:app --host 0.0.0.0 --port 8000

          # Restart frontend service with environment loaded
          echo "==> Restarting frontend service..."
          cd "$CURRENT_DIR/frontend"
          # Load environment variables from .env.production
          set -a
          source .env.production
          set +a
          pm2 restart auto-author-frontend || pm2 start npm --name auto-author-frontend --cwd "$CURRENT_DIR/frontend" -- start

          # Wait for services to start (Next.js needs more time)
          echo "==> Waiting for services to initialize..."
          sleep 10

          # Health checks with retries
          echo "==> Running health checks..."
          
          # Backend health check
          MAX_RETRIES=5
          RETRY_COUNT=0
          until curl -f http://localhost:8000/api/v1/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "Backend health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 2s..."
            sleep 2
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "ERROR: Backend health check failed after $MAX_RETRIES attempts"
            exit 1
          fi
          echo "✓ Backend health check passed"

          # Frontend health check with retries
          RETRY_COUNT=0
          until curl -f -s http://localhost:3002 >/dev/null || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "Frontend health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 3s..."
            sleep 3
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "ERROR: Frontend health check failed after $MAX_RETRIES attempts"
            echo "Checking PM2 logs..."
            pm2 logs auto-author-frontend --lines 50 --nostream
            exit 1
          fi
          echo "✓ Frontend health check passed"

          echo "==> Deployment successful!"
          echo "    Release: $RELEASE_ID"
          echo "    Backend: http://localhost:8000"
          echo "    Frontend: http://localhost:3002"

          # Cleanup old releases (keep last 5)
          cd "$DEPLOY_BASE/releases"
          ls -t | tail -n +6 | xargs -r rm -rf

          echo "==> Cleanup complete"
          ENDSSH

      - name: Health checks
        run: |
          # Wait for services to stabilize
          sleep 10

          # Backend health check
          echo "Checking backend health..."
          curl -f https://api.dev.autoauthor.app/api/v1/health || exit 1

          # Frontend health check
          echo "Checking frontend health..."
          curl -f https://dev.autoauthor.app || exit 1

          # CORS verification
          echo "Checking CORS headers..."
          curl -I -X OPTIONS https://api.dev.autoauthor.app/api/v1/books \
            -H "Origin: https://dev.autoauthor.app" \
            -H "Access-Control-Request-Method: GET" | grep -i "access-control-allow-origin" || exit 1

      - name: Smoke tests
        run: |
          # Test API docs endpoint
          curl -f https://api.dev.autoauthor.app/docs || exit 1

          echo "✅ All smoke tests passed"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/staging_key
          rm -f /tmp/deploy-package.tar.gz