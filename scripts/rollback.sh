#!/bin/bash
set -e

# Rollback script for Auto-Author staging environment
# This script rolls back to the previous release by updating the symlink

RELEASES_DIR="/opt/auto-author/releases"
CURRENT_LINK="/opt/auto-author/current"

# Get previous release (second most recent)
PREVIOUS=$(ls -t $RELEASES_DIR | sed -n '2p')

if [ -z "$PREVIOUS" ]; then
  echo "‚ùå No previous release found"
  exit 1
fi

echo "üîÑ Rolling back to: $PREVIOUS"
ln -sfn $RELEASES_DIR/$PREVIOUS $CURRENT_LINK

echo "‚ôªÔ∏è  Restarting services..."
pm2 restart all

echo "üè• Running health checks..."
sleep 5

# Backend health check
if ! curl -f https://api.dev.autoauthor.app/api/v1/health; then
  echo "‚ùå Backend health check failed"
  exit 1
fi

# Frontend health check
if ! curl -f https://dev.autoauthor.app; then
  echo "‚ùå Frontend health check failed"
  exit 1
fi

echo "‚úÖ Rollback complete"
echo "üì¶ Rolled back to: $PREVIOUS"
