# Pre-commit hooks configuration for Auto-Author
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Auto-sync documentation with bd tracker
  - repo: local
    hooks:
      - id: export-current-sprint
        name: Export Current Sprint from bd
        entry: ./scripts/export-current-sprint.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        verbose: true

      - id: export-implementation-plan
        name: Export Implementation Plan from bd
        entry: ./scripts/export-implementation-plan.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        verbose: true

      - id: auto-add-exports
        name: Auto-add exported documentation files
        entry: bash -c 'git add CURRENT_SPRINT.md IMPLEMENTATION_PLAN.md 2>/dev/null || true'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

  # Security - Check for secrets and credentials
  - repo: local
    hooks:
      - id: check-secrets
        name: Check for secrets and credentials
        entry: ./scripts/check-secrets.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        verbose: true

  # Frontend testing
  - repo: local
    hooks:
      - id: frontend-lint
        name: Frontend Linting
        entry: bash -c 'cd frontend && npm run lint'
        language: system
        files: ^frontend/
        pass_filenames: false

      - id: frontend-typecheck
        name: Frontend Type Checking
        entry: bash -c 'cd frontend && npm run typecheck'
        language: system
        files: ^frontend/
        pass_filenames: false

      - id: frontend-unit-tests
        name: Frontend Unit Tests
        entry: bash -c 'cd frontend && npm test -- --passWithNoTests --watchAll=false'
        language: system
        files: ^frontend/
        pass_filenames: false

      - id: frontend-coverage
        name: Frontend Coverage Check (≥85%)
        entry: bash -c 'cd frontend && npm test -- --coverage --coverageThreshold="{\"global\":{\"lines\":85,\"statements\":85,\"branches\":75,\"functions\":85}}" --watchAll=false'
        language: system
        files: ^frontend/
        pass_filenames: false

      - id: frontend-e2e-tests
        name: Frontend E2E Tests (Playwright)
        entry: bash -c 'cd frontend && BYPASS_AUTH=true npx playwright test'
        language: system
        files: ^frontend/
        pass_filenames: false

  # Backend testing
  - repo: local
    hooks:
      - id: backend-lint
        name: Backend Linting (ruff)
        entry: bash -c 'cd backend && uv run ruff check app/ tests/ || true'
        language: system
        files: ^backend/
        pass_filenames: false

      - id: backend-unit-tests
        name: Backend Unit Tests
        entry: bash -c 'cd backend && uv run pytest tests/'
        language: system
        files: ^backend/
        pass_filenames: false
        require_serial: true

      - id: backend-coverage
        name: Backend Coverage Check (≥85%)
        entry: bash -c 'cd backend && uv run pytest tests/ --cov=app --cov-fail-under=85'
        language: system
        files: ^backend/
        pass_filenames: false
        require_serial: true

  # General code quality
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        exclude: '\.md$'
      - id: end-of-file-fixer
        exclude: '\.md$'
      - id: check-yaml
        exclude: '^\.github/workflows/'
      - id: check-json
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: detect-private-key
      - id: mixed-line-ending

# Configuration
default_install_hook_types: [pre-commit, commit-msg]
default_stages: [pre-commit]
fail_fast: false
